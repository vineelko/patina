# @file ReleaseWorkflow.yml
#
# A reusable CI workflow that releases all crates in a repository.
#
##
# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: BSD-2-Clause-Patent
##
name: Publish

on:
  workflow_call:
    secrets:
      GH_PAT:
        description: 'The GitHub Personal Access Token to use for authenticating with GitHub'
        required: true
      CRATES_IO_TOKEN:
        description: 'The token to use for authenticating with crates.io'
        required: true

jobs:
  run:
    name: Publish

    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read
      pull-requests: write

    steps:
      - name: âœ… Checkout Repository âœ…
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Download Rust Tools ðŸ› ï¸
        uses: pop-project/uefi-dxe-core/.github/actions/rust-tool-cache@main

      - name: Add Credentials # Remove once repositories are public
        run: |
          git config --global url."https://${{ secrets.GH_PAT }}@github.com".insteadOf https://github.com
        shell: bash

      - name: Get Release Tag
        id: release_tag
        run: |
          tag_name="${{ github.event.release.tag_name }}"
          
          # remove the leading 'v' if it exists
          release_tag="${tag_name#v}" 

          echo "Release Tag: $release_tag"
          echo "tag=$release_tag" >> $GITHUB_OUTPUT
        shell: bash

      - name: Setup Cred Provider
        run: |
          mkdir -p ~/.cargo
          cat <<EOF >> ~/.cargo/config.toml
          [registry]
          global-credential-providers = ["cargo:token"]
          EOF

      - name: Login to Registry
        run: cargo login "${{ secrets.CRATES_IO_TOKEN }}" --registry UefiRust

      - name: Cargo Release Dry Run
        run: cargo release ${{ steps.release_tag.outputs.tag }} --workspace
        env:
          RUSTC_BOOTSTRAP: 1

      - name: Update git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Cargo Release
        run: cargo release ${{ steps.release_tag.outputs.tag }} -x --no-tag --no-confirm --workspace --no-push
        env:
          RUSTC_BOOTSTRAP: 1

      - name: Checkout New Branch
        run: |
          git checkout -b "github-actions/release-${{ steps.release_tag.outputs.tag }}"
          git push origin "github-actions/release-${{ steps.release_tag.outputs.tag }}"
    
      - name: Publish PR
        uses: actions/github-script@v7
        with:
          script: |
            const defaultBranch = context.payload.repository.default_branch;

            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'chore: Update repo version to ${{ steps.release_tag.outputs.tag }}',
              head: `github-actions/release-${{ steps.release_tag.outputs.tag }}`,
              base: defaultBranch,
              body: 'An automatically created pull request to update the version of the repo due to a release.',
              draft: false
            });

            console.log(`PR created ${pullRequest.html_url}`);
